<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head th:replace="~{fragments/nk-head::head}"></head>

<body class="nk-body bg-lighter npc-default has-sidebar ">

<div class="nk-app-root">
    <div th:replace="~{fragments/nk-side::sidebar}"></div>
    <div class="nk-wrap">
        <div th:replace="~{fragments/nk-header::header}"></div>

        <!-- ========== CHỈ PHẦN NÀY KHÁC ========== -->
        <div class="nk-content">

            <div class="nk-block-head nk-block-head-sm">
                <div class="nk-block-between">
                    <div class="nk-block-head-content">
                        <h3 class="nk-block-title page-title">
                            Lịch Hẹn Được Giao
                            <small class="text-primary"
                                   th:text="'('+ ${totalElements} +' booking)'">(0)</small>
                        </h3>
                    </div>
                </div>
            </div>

            <!-- Today's quick board -->
            <div class="nk-block">
                <div class="card card-bordered">
                    <div class="card-inner">
                        <h5 class="title">Lịch hôm nay</h5>
                        <div class="row g-4">
                            <div th:each="t : ${todayBookings}" class="col-6 col-md-3">
                                <div class="alert alert-fill alert-primary d-flex flex-column align-items-center text-center">
                                    <div>
                                        <em class="icon ni ni-clock"></em>
                                        <span class="lead"
                                              th:text="${#temporals.format(t.bookingTime,'HH:mm')}"></span>
                                    </div>
                                    <div th:text="${t.serviceName}">Service</div>
                                    <small th:text="${t.customerName}">Khách hàng</small>
                                </div>
                            </div>
                            <div th:if="${#lists.isEmpty(todayBookings)}" class="col-12 text-center">
                                <span class="text-soft">Không có lịch hôm nay.</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- nk-block -->

            <!-- MAIN TABLE -->
            <div class="nk-block">
                <div class="card card-bordered card-stretch">
                    <div class="card-inner-group">

                        <div class="card-inner p-0">
                            <table class="table table-tranx">
                                <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Dịch vụ</th>
                                    <th>Khách</th>
                                    <th>Ngày/Giờ</th>
                                    <th>Trạng thái</th>
                                    <th class="text-end">Hành động</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="b : ${bookings}">
                                    <td th:text="${b.bookingId}">BK001</td>
                                    <td>
                                        <span th:text="${b.serviceName}">Service</span>
                                        <br/><small class="text-soft"
                                                    th:text="${b.serviceDuration}">60’</small>
                                    </td>
                                    <td>
                                        <span th:text="${b.customerName}">Customer</span>
                                        <br/><small class="text-soft"
                                                    th:text="${b.customerPhone}"></small>
                                    </td>
                                    <td th:text="${b.formattedBookingDateTime}">22/07 14:00</td>
                                    <td>
                                        <span class="badge"
                                              th:class="'badge-' + ${b.status.name().toLowerCase()}"
                                              th:text="${b.statusDisplayName}">Assigned</span>
                                    </td>
                                    <td class="text-end">
                                        <button th:if="${b.canBeStarted}"
                                                class="btn btn-sm btn-outline-warning"
                                                th:attr="data-id=${b.bookingId}"
                                                onclick="startSvc(this)">
                                            <em class="icon ni ni-play"></em>
                                        </button>
                                        <button th:if="${b.canBeCompleted}"
                                                class="btn btn-sm btn-outline-success"
                                                th:attr="data-id=${b.bookingId}"
                                                onclick="doneSvc(this)">
                                            <em class="icon ni ni-check"></em>
                                        </button>
                                        <button th:if="${b.canBeCancelled}"
                                                class="btn btn-sm btn-outline-danger"
                                                th:attr="data-id=${b.bookingId}"
                                                onclick="cancelSvc(this)">
                                            <em class="icon ni ni-cross"></em>
                                        </button>
                                    </td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(bookings)}">
                                    <td colspan="6" class="text-center p-4">
                                        <em class="icon ni ni-calendar-x-fill display-4 text-soft"></em>
                                        <p class="mt-2">Chưa có lịch được giao.</p>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- PAGINATION -->
                        <div class="card-inner">
                            <div class="nk-block-between-md g-3">
                                <nav th:if="${totalPages > 1}">
                                    <ul class="pagination justify-content-center">
                                        <li class="page-item" th:classappend="${!hasPrevious}? 'disabled'">
                                            <a class="page-link" th:href="@{/admin/bookings/staff(page=${currentPage})}">
                                                <em class="icon ni ni-chevron-left"></em>
                                            </a>
                                        </li>
                                        <li class="page-item"
                                            th:each="p : ${#numbers.sequence(0,totalPages)}"
                                            th:classappend="${p==currentPage}? 'active'">
                                            <a class="page-link" th:href="@{/admin/bookings/staff(page=${p})}"
                                               th:text="${p+1}">1</a>
                                        </li>
                                        <li class="page-item" th:classappend="${!hasNext}? 'disabled'">
                                            <a class="page-link" th:href="@{/admin/bookings/staff(page=${currentPage+1})}">
                                                <em class="icon ni ni-chevron-right"></em>
                                            </a>
                                        </li>
                                    </ul>
                                </nav>
                                <div class="text-soft">
                                    <span th:text="${bookings.size()}"></span>/<span th:text="${totalElements}"></span>
                                </div>
                            </div>
                        </div><!-- card-inner -->
                    </div>
                </div><!-- card -->
            </div><!-- nk-block -->

        </div><!-- nk-content -->
        <!-- ========== END CHANGED PART ========== -->

        <div th:replace="~{fragments/nk-footer::footer}"></div>
    </div>
</div>

<div th:replace="~{fragments/nk-script::scripts}"></div>

<script>
    function startSvc(btn){
        $.post('/admin/bookings/staff/start/'+btn.dataset.id).done(()=>location.reload());
    }
    function doneSvc(btn){
        $.post('/admin/bookings/staff/complete/'+btn.dataset.id,
            JSON.stringify({completionNotes:''}),
            'json').done(()=>location.reload());
    }
    function cancelSvc(btn){
        const reason = prompt('Lý do hủy?');
        if(!reason) return;
        $.post('/admin/bookings/staff/cancel/'+btn.dataset.id,
            JSON.stringify({cancellationReason:reason}),
            'json').done(()=>location.reload());
    }
</script>
</body>
</html>
